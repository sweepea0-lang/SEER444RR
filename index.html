<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profit Control Dashboard (TH) ‚Äì Company 15% from Total Wager</title>
  <style>
    body{font-family:system-ui,Segoe UI,Tahoma,sans-serif;margin:0;background:#0b1220;color:#e8eefc}
    header{padding:18px 18px 10px;border-bottom:1px solid #22304e;background:#0f1a33;position:sticky;top:0;z-index:5}
    h1{margin:0;font-size:18px}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:900px){.grid{grid-template-columns:1.2fr .8fr}}
    .card{background:#0f1a33;border:1px solid #22304e;border-radius:14px;padding:14px}
    .card h2{margin:0 0 10px;font-size:15px}
    .row{display:grid;grid-template-columns:1fr 180px;gap:10px;align-items:center;margin:8px 0}
    .row small{color:#a9b8dd}
    input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #2a3a5f;background:#0b1220;color:#e8eefc}
    .sec{margin-top:10px;padding-top:10px;border-top:1px dashed #22304e}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid #2a3a5f;background:#0b1220}
    .ok{color:#3ddc97}
    .bad{color:#ff6b6b}
    .warn{color:#ffd166}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{padding:10px 12px;border-radius:10px;border:1px solid #2a3a5f;background:#122145;color:#e8eefc;cursor:pointer}
    button:hover{filter:brightness(1.08)}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{border-bottom:1px solid #22304e;padding:10px;text-align:left}
    th{color:#a9b8dd;font-weight:600}
    .right{text-align:right}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>
</head>
<body>
<header>
  <h1>Profit Control Dashboard (TH) ‚Äî ‡∏™‡∏•‡πá‡∏≠‡∏ï/‡∏Å‡∏µ‡∏¨‡∏≤/‡∏´‡∏ß‡∏¢</h1>
  <div style="margin-top:8px;color:#a9b8dd;font-size:13px">
    ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: <b>‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏û‡∏≤‡∏ô‡∏µ 15%</b> ‡∏Ñ‡∏¥‡∏î‡∏à‡∏≤‡∏Å <b>‡∏¢‡∏≠‡∏î‡πÄ‡∏•‡πà‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Total Wager)</b>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <!-- INPUT -->
    <div class="card">
      <h2>INPUT (‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤)</h2>

      <div class="row">
        <div><b>‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£/‡πÅ‡∏Ñ‡∏°‡πÄ‡∏õ‡∏ç</b><br><small>‡πÄ‡∏ä‡πà‡∏ô ‡∏ù‡∏≤‡∏Å‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô / ‡∏Ñ‡∏∑‡∏ô‡∏¢‡∏≠‡∏î‡πÄ‡∏™‡∏µ‡∏¢</small></div>
        <input id="campaign" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£">
      </div>
      <div class="row">
        <div><b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</b><br><small>YYYY-MM-DD</small></div>
        <input id="date" placeholder="2025-12-24">
      </div>

      <div class="row">
        <div><b>% ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡πÄ‡∏≠‡πÄ‡∏¢‡πà‡∏ô‡∏ï‡πå</b><br><small>‡πÄ‡∏ä‡πà‡∏ô 10% ‡πÉ‡∏™‡πà 0.10 (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏™‡πà 0)</small></div>
        <input id="agentRate" type="number" step="0.01" value="0.00">
      </div>
      <div class="row">
        <div><b>% ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏û‡∏≤‡∏ô‡∏µ</b><br><small>‡∏Ñ‡∏¥‡∏î‡∏à‡∏≤‡∏Å ‚Äú‡∏¢‡∏≠‡∏î‡πÄ‡∏•‡πà‡∏ô‡∏£‡∏ß‡∏°‚Äù (Total Wager) ‡πÄ‡∏ä‡πà‡∏ô 15% ‡πÉ‡∏™‡πà 0.15</small></div>
        <input id="companyRate" type="number" step="0.01" value="0.15">
      </div>
      <div class="row">
        <div><b>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏ö‡∏≤‡∏ó)</b><br><small>‡∏Ñ‡πà‡∏≤‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤/‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏° ‡∏Ø‡∏•‡∏Ø</small></div>
        <input id="otherCost" type="number" step="1" value="0">
      </div>

      <!-- SLOT -->
      <div class="sec">
        <h2 style="margin:0 0 8px">‡∏™‡∏•‡πá‡∏≠‡∏ï</h2>
        <div class="row"><div>‡πÇ‡∏´‡∏°‡∏î</div>
          <select id="slotMode"><option>RTP</option><option>Margin</option></select>
        </div>
        <div class="row"><div>‡∏ù‡∏≤‡∏Å (D)</div><input id="slotD" type="number" step="1" value="0"></div>
        <div class="row"><div>‡πÇ‡∏ö‡∏ô‡∏±‡∏™ (B)</div><input id="slotB" type="number" step="1" value="0"></div>
        <div class="row"><div>‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô (T)</div><input id="slotT" type="number" step="0.1" value="5"></div>
        <div class="row"><div>RTP (0‚Äì1)</div><input id="slotRTP" type="number" step="0.01" value="0.96"></div>
        <div class="row"><div>Margin (0‚Äì1)</div><input id="slotM" type="number" step="0.01" value="0.08"></div>
        <div class="row"><div>‡∏ñ‡∏≠‡∏ô (W)</div><input id="slotW" type="number" step="1" value="0"></div>
      </div>

      <!-- SPORT -->
      <div class="sec">
        <h2 style="margin:0 0 8px">‡∏Å‡∏µ‡∏¨‡∏≤</h2>
        <div class="row"><div>‡πÇ‡∏´‡∏°‡∏î</div>
          <select id="sportMode"><option>Margin</option><option>RTP</option></select>
        </div>
        <div class="row"><div>‡∏ù‡∏≤‡∏Å (D)</div><input id="sportD" type="number" step="1" value="0"></div>
        <div class="row"><div>‡πÇ‡∏ö‡∏ô‡∏±‡∏™ (B)</div><input id="sportB" type="number" step="1" value="0"></div>
        <div class="row"><div>‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô (T)</div><input id="sportT" type="number" step="0.1" value="1"></div>
        <div class="row"><div>RTP (0‚Äì1)</div><input id="sportRTP" type="number" step="0.01" value="0.00"></div>
        <div class="row"><div>Margin (0‚Äì1)</div><input id="sportM" type="number" step="0.01" value="0.10"></div>
        <div class="row"><div>‡∏ñ‡∏≠‡∏ô (W)</div><input id="sportW" type="number" step="1" value="0"></div>
      </div>

      <!-- LOTTO -->
      <div class="sec">
        <h2 style="margin:0 0 8px">‡∏´‡∏ß‡∏¢</h2>
        <div class="row"><div>‡πÇ‡∏´‡∏°‡∏î</div>
          <select id="lottoMode"><option>Margin</option><option>RTP</option></select>
        </div>
        <div class="row"><div>‡∏ù‡∏≤‡∏Å (D)</div><input id="lottoD" type="number" step="1" value="0"></div>
        <div class="row"><div>‡πÇ‡∏ö‡∏ô‡∏±‡∏™ (B)</div><input id="lottoB" type="number" step="1" value="0"></div>
        <div class="row"><div>‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô (T)</div><input id="lottoT" type="number" step="0.1" value="1"></div>
        <div class="row"><div>RTP (0‚Äì1)</div><input id="lottoRTP" type="number" step="0.01" value="0.00"></div>
        <div class="row"><div>Margin (0‚Äì1)</div><input id="lottoM" type="number" step="0.01" value="0.05"></div>
        <div class="row"><div>‡∏ñ‡∏≠‡∏ô (W)</div><input id="lottoW" type="number" step="1" value="0"></div>
      </div>

      <div class="btns">
        <button id="saveBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á LOG</button>
        <button id="exportBtn">Export CSV</button>
        <button id="clearBtn">‡∏•‡πâ‡∏≤‡∏á LOG</button>
      </div>
      <div style="margin-top:8px;color:#a9b8dd;font-size:12px">
        * LOG ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (LocalStorage) ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÑ‡∏´‡∏ô
      </div>
    </div>

    <!-- RESULT -->
    <div class="card">
      <h2>RESULT (‡∏™‡∏£‡∏∏‡∏õ)</h2>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">
        <span class="pill">‡∏ù‡∏≤‡∏Å‡∏£‡∏ß‡∏°: <b id="sumD">0</b></span>
        <span class="pill">‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏£‡∏ß‡∏°: <b id="sumB">0</b></span>
        <span class="pill">‡∏ñ‡∏≠‡∏ô‡∏£‡∏ß‡∏°: <b id="sumW">0</b></span>
        <span class="pill">Expected Loss ‡∏£‡∏ß‡∏°: <b id="sumLoss">0</b></span>
        <span class="pill">‡∏¢‡∏≠‡∏î‡πÄ‡∏•‡πà‡∏ô‡∏£‡∏ß‡∏°: <b id="sumWager">0</b></span>
      </div>

      <div class="card" style="background:#0b1220">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="color:#a9b8dd">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div>
            <div style="font-size:26px;font-weight:800" id="netProfit">0</div>
          </div>
          <div style="font-size:18px;font-weight:800" id="status">-</div>
        </div>
        <div style="margin-top:10px;color:#a9b8dd;font-size:12px" class="mono" id="profitFormula"></div>
      </div>

      <div class="sec">
        <h2 style="margin:0 0 8px">ALERT</h2>
        <div class="row"><div>‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏£‡∏ß‡∏° > 30% ‡∏Ç‡∏≠‡∏á‡∏ù‡∏≤‡∏Å‡∏£‡∏ß‡∏°</div><div id="a1" class="pill">-</div></div>
        <div class="row"><div>Expected Loss ‡∏£‡∏ß‡∏° < ‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏£‡∏ß‡∏°</div><div id="a2" class="pill">-</div></div>
        <div class="row"><div>‡∏ñ‡∏≠‡∏ô‡∏£‡∏ß‡∏° > ‡∏ù‡∏≤‡∏Å‡∏£‡∏ß‡∏° + Expected Loss</div><div id="a3" class="pill">-</div></div>
      </div>

      <div class="sec">
        <h2 style="margin:0 0 8px">‡∏Ñ‡πà‡∏≤‡∏´‡∏±‡∏Å‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</h2>
        <div class="row"><div>‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡πÄ‡∏≠‡πÄ‡∏¢‡πà‡∏ô‡∏ï‡πå (‡∏ù‡∏≤‡∏Å‡∏£‡∏ß‡∏° √ó %)</div><div class="pill"><b id="agentFee">0</b></div></div>
        <div class="row"><div>‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏û‡∏≤‡∏ô‡∏µ (‡∏¢‡∏≠‡∏î‡πÄ‡∏•‡πà‡∏ô‡∏£‡∏ß‡∏° √ó 15%)</div><div class="pill"><b id="companyFee">0</b></div></div>
        <div class="row"><div>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ</div><div class="pill"><b id="otherCostShow">0</b></div></div>
      </div>

      <div class="sec">
        <h2 style="margin:0 0 8px">LOSS / ‡∏¢‡∏≠‡∏î‡πÄ‡∏•‡πà‡∏ô ‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</h2>
        <div class="row"><div>‡∏™‡∏•‡πá‡∏≠‡∏ï Loss</div><div class="pill"><b id="slotLoss">0</b></div></div>
        <div class="row"><div>‡∏™‡∏•‡πá‡∏≠‡∏ï ‡∏¢‡∏≠‡∏î‡πÄ‡∏•‡πà‡∏ô</div><div class="pill"><b id="slotWager">0</b></div></div>

        <div class="row"><div>‡∏Å‡∏µ‡∏¨‡∏≤ Loss</div><div class="pill"><b id="sportLoss">0</b></div></div>
        <div class="row"><div>‡∏Å‡∏µ‡∏¨‡∏≤ ‡∏¢‡∏≠‡∏î‡πÄ‡∏•‡πà‡∏ô</div><div class="pill"><b id="sportWager">0</b></div></div>

        <div class="row"><div>‡∏´‡∏ß‡∏¢ Loss</div><div class="pill"><b id="lottoLoss">0</b></div></div>
        <div class="row"><div>‡∏´‡∏ß‡∏¢ ‡∏¢‡∏≠‡∏î‡πÄ‡∏•‡πà‡∏ô</div><div class="pill"><b id="lottoWager">0</b></div></div>
      </div>
    </div>
  </div>

  <!-- LOG -->
  <div class="card" style="margin-top:12px">
    <h2>LOG (‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥)</h2>
    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£</th>
            <th class="right">‡∏ù‡∏≤‡∏Å‡∏£‡∏ß‡∏°</th>
            <th class="right">‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏£‡∏ß‡∏°</th>
            <th class="right">‡∏ñ‡∏≠‡∏ô‡∏£‡∏ß‡∏°</th>
            <th class="right">‡∏¢‡∏≠‡∏î‡πÄ‡∏•‡πà‡∏ô‡∏£‡∏ß‡∏°</th>
            <th class="right">Loss ‡∏£‡∏ß‡∏°</th>
            <th class="right">‡∏Ñ‡∏≠‡∏°‡∏û‡∏≤‡∏ô‡∏µ</th>
            <th class="right">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          </tr>
        </thead>
        <tbody id="logBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  const $ = (id)=>document.getElementById(id);
  const fmt = (n)=> (isFinite(n)? new Intl.NumberFormat('th-TH',{maximumFractionDigits:2}).format(n): '0');
  const num = (id)=> parseFloat($(id).value || "0") || 0;

  function rate(mode, rtp, margin){
    return (mode==="RTP") ? (1 - rtp) : margin;
  }
  function expectedLoss(D,B,T,mode,rtp,margin){
    const r = rate(mode, rtp, margin);
    return (D + B) * T * r;
  }
  function totalWager(D,B,T){
    return (D + B) * T;
  }

  function compute(){
    const agentRate   = num("agentRate");
    const companyRate = num("companyRate"); // 0.15
    const otherCost   = num("otherCost");

    const slot = { mode: $("slotMode").value, D:num("slotD"), B:num("slotB"), T:num("slotT"), RTP:num("slotRTP"), M:num("slotM"), W:num("slotW") };
    const sport= { mode: $("sportMode").value, D:num("sportD"),B:num("sportB"),T:num("sportT"),RTP:num("sportRTP"),M:num("sportM"),W:num("sportW") };
    const lotto= { mode: $("lottoMode").value, D:num("lottoD"),B:num("lottoB"),T:num("lottoT"),RTP:num("lottoRTP"),M:num("lottoM"),W:num("lottoW") };

    const slotLoss  = expectedLoss(slot.D, slot.B, slot.T, slot.mode, slot.RTP, slot.M);
    const sportLoss = expectedLoss(sport.D, sport.B, sport.T, sport.mode, sport.RTP, sport.M);
    const lottoLoss = expectedLoss(lotto.D, lotto.B, lotto.T, lotto.mode, lotto.RTP, lotto.M);

    const slotWager  = totalWager(slot.D, slot.B, slot.T);
    const sportWager = totalWager(sport.D, sport.B, sport.T);
    const lottoWager = totalWager(lotto.D, lotto.B, lotto.T);

    const sumD = slot.D + sport.D + lotto.D;
    const sumB = slot.B + sport.B + lotto.B;
    const sumW = slot.W + sport.W + lotto.W;

    const sumLoss  = slotLoss + sportLoss + lottoLoss;
    const sumWager = slotWager + sportWager + lottoWager;

    // fees
    const agentFee   = sumD * agentRate;         // from deposit
    const companyFee = sumWager * companyRate;   // from total wager (IMPORTANT)

    // Net Profit (aligned with updated Excel)
    // net = deposits - bonuses - withdrawals - agentFee - companyFee - otherCost + expectedLoss
    const net = sumD - sumB - sumW - agentFee - companyFee - otherCost + sumLoss;

    // render
    $("sumD").textContent = fmt(sumD);
    $("sumB").textContent = fmt(sumB);
    $("sumW").textContent = fmt(sumW);
    $("sumLoss").textContent = fmt(sumLoss);
    $("sumWager").textContent = fmt(sumWager);

    $("agentFee").textContent = fmt(agentFee);
    $("companyFee").textContent = fmt(companyFee);
    $("otherCostShow").textContent = fmt(otherCost);

    $("slotLoss").textContent = fmt(slotLoss);
    $("sportLoss").textContent = fmt(sportLoss);
    $("lottoLoss").textContent = fmt(lottoLoss);

    $("slotWager").textContent = fmt(slotWager);
    $("sportWager").textContent = fmt(sportWager);
    $("lottoWager").textContent = fmt(lottoWager);

    $("netProfit").textContent = fmt(net);
    $("status").textContent = (net>0) ? "üü¢ ‡∏Å‡∏≥‡πÑ‡∏£" : "üî¥ ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á";
    $("status").className = (net>0) ? "ok" : "bad";

    $("profitFormula").textContent =
      "‡∏Å‡∏≥‡πÑ‡∏£ = ‡∏ù‡∏≤‡∏Å‡∏£‡∏ß‡∏° - ‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏£‡∏ß‡∏° - ‡∏ñ‡∏≠‡∏ô‡∏£‡∏ß‡∏° - (‡∏ù‡∏≤‡∏Å√ó%‡πÄ‡∏≠‡πÄ‡∏¢‡πà‡∏ô‡∏ï‡πå) - (‡∏¢‡∏≠‡∏î‡πÄ‡∏•‡πà‡∏ô√ó%‡∏Ñ‡∏≠‡∏°‡∏û‡∏≤‡∏ô‡∏µ) - ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏≠‡∏∑‡πà‡∏ô + ExpectedLoss‡∏£‡∏ß‡∏°";

    // alerts
    const a1 = (sumD>0 && (sumB/sumD)>0.30) ? "‚ö†Ô∏è YES" : "OK";
    const a2 = (sumLoss < sumB) ? "‚ö†Ô∏è YES" : "OK";
    const a3 = (sumW > (sumD + sumLoss)) ? "‚ö†Ô∏è YES" : "OK";
    setAlert("a1", a1); setAlert("a2", a2); setAlert("a3", a3);

    return {sumD,sumB,sumW,sumWager,sumLoss,agentFee,companyFee,otherCost,net};
  }

  function setAlert(id, v){
    const el = $(id);
    el.textContent = v;
    el.className = "pill " + (v.includes("YES") ? "warn" : "ok");
  }

  // LOG
  const STORAGE_KEY = "profit_control_log_v2_company_wager";
  function loadLog(){
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
    catch { return []; }
  }
  function saveLog(arr){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
  }
  function renderLog(){
    const arr = loadLog();
    const tbody = $("logBody");
    tbody.innerHTML = "";
    for(const row of arr){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.date||""}</td>
        <td>${row.campaign||""}</td>
        <td class="right">${fmt(row.sumD)}</td>
        <td class="right">${fmt(row.sumB)}</td>
        <td class="right">${fmt(row.sumW)}</td>
        <td class="right">${fmt(row.sumWager)}</td>
        <td class="right">${fmt(row.sumLoss)}</td>
        <td class="right">${fmt(row.companyFee)}</td>
        <td class="right"><b>${fmt(row.net)}</b></td>
        <td>${row.net>0 ? "üü¢" : "üî¥"}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  function exportCSV(){
    const arr = loadLog();
    const header = ["date","campaign","sumD","sumB","sumW","sumWager","sumLoss","agentFee","companyFee","otherCost","net"];
    const lines = [header.join(",")];
    for(const r of arr){
      const row = [r.date,r.campaign,r.sumD,r.sumB,r.sumW,r.sumWager,r.sumLoss,r.agentFee,r.companyFee,r.otherCost,r.net]
        .map(x=> `"${String(x??"").replaceAll('"','""')}"`).join(",");
      lines.push(row);
    }
    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "profit_control_log.csv";
    a.click();
    URL.revokeObjectURL(url);
  }

  // Wire up
  document.querySelectorAll("input,select").forEach(el=>{
    el.addEventListener("input", compute);
    el.addEventListener("change", compute);
  });

  $("saveBtn").addEventListener("click", ()=>{
    const snap = compute();
    const arr = loadLog();
    arr.unshift({
      date: $("date").value.trim(),
      campaign: $("campaign").value.trim(),
      ...snap,
      ts: Date.now()
    });
    saveLog(arr.slice(0,500));
    renderLog();
  });

  $("exportBtn").addEventListener("click", exportCSV);
  $("clearBtn").addEventListener("click", ()=>{
    localStorage.removeItem(STORAGE_KEY);
    renderLog();
  });

  // init
  compute();
  renderLog();
</script>
</body>
</html>
